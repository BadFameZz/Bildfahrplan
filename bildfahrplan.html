<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Bildfahrplan</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  height: 100%;
  overflow: hidden;
  -webkit-text-size-adjust: 100%;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 16px;
  background: #e8eaed;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.app {
  display: flex;
  height: 100vh;
  height: 100dvh;
  gap: 8px;
  padding: 8px;
}
.panel {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.panel-left {
  flex: 0 0 380px;
  min-width: 320px;
}
.panel-right {
  flex: 1;
  min-width: 300px;
}
.panel-header {
  background: #1a73e8;
  color: #fff;
  padding: 14px 16px;
  font-size: 18px;
  font-weight: 600;
  flex-shrink: 0;
}
.panel-content {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 16px;
}
.section {
  margin-bottom: 20px;
}
.section-title {
  font-size: 13px;
  font-weight: 600;
  color: #5f6368;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 2px solid #e8eaed;
}
label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  color: #3c4043;
  margin-bottom: 6px;
}
textarea, input[type="text"], input[type="time"], select {
  width: 100%;
  padding: 14px;
  border: 2px solid #dadce0;
  border-radius: 8px;
  font-size: 16px;
  background: #fff;
  color: #202124;
  -webkit-appearance: none;
  appearance: none;
  transition: border-color 0.2s;
}
textarea:focus, input:focus, select:focus {
  outline: none;
  border-color: #1a73e8;
}
textarea {
  resize: none;
  min-height: 120px;
  font-family: 'Roboto Mono', monospace;
  line-height: 1.5;
}
select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='%235f6368' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 40px;
}
.row {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}
.row > * { flex: 1; }
.btn-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 8px;
}
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 14px 20px;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  touch-action: manipulation;
  transition: transform 0.1s, box-shadow 0.1s;
  min-height: 48px;
  gap: 8px;
}
.btn:active {
  transform: scale(0.96);
}
.btn-primary { background: #1a73e8; color: #fff; }
.btn-primary:active { background: #1557b0; }
.btn-success { background: #1e8e3e; color: #fff; }
.btn-success:active { background: #137333; }
.btn-warning { background: #f9ab00; color: #202124; }
.btn-warning:active { background: #e69500; }
.btn-danger { background: #d93025; color: #fff; }
.btn-danger:active { background: #b3261e; }
.btn-secondary { background: #e8eaed; color: #3c4043; }
.btn-secondary:active { background: #dadce0; }
.btn-icon {
  padding: 12px;
  min-width: 48px;
}
.btn-full { flex: 1; }
.zug-card {
  background: #f8f9fa;
  border: 2px solid #e8eaed;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 14px;
}
.zug-card-header {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 12px;
}
.zug-card-header input {
  margin-bottom: 0;
}
.zug-card-header .btn {
  padding: 12px 14px;
  flex-shrink: 0;
}
.stops-grid {
  display: grid;
  grid-template-columns: 1fr 100px 100px;
  gap: 8px;
  align-items: center;
}
.stops-grid-header {
  font-size: 12px;
  font-weight: 600;
  color: #5f6368;
  text-transform: uppercase;
  padding: 8px 0;
}
.stops-grid-header:nth-child(2),
.stops-grid-header:nth-child(3) {
  text-align: center;
}
.stop-name {
  font-size: 14px;
  font-weight: 500;
  color: #202124;
  padding: 10px 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.stops-grid input[type="time"] {
  padding: 10px 8px;
  font-size: 15px;
  text-align: center;
}
.canvas-container {
  flex: 1;
  position: relative;
  background: #fff;
  min-height: 200px;
}
#canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}
.status-bar {
  padding: 12px 16px;
  background: #f1f3f4;
  font-size: 13px;
  font-family: 'Roboto Mono', monospace;
  color: #5f6368;
  border-top: 1px solid #e8eaed;
  flex-shrink: 0;
}
.status-ok { color: #1e8e3e; }
.status-warn { color: #d93025; }
.legend {
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #3c4043;
}
.legend-color {
  width: 28px;
  height: 4px;
  border-radius: 2px;
}
.empty-hint {
  text-align: center;
  padding: 30px;
  color: #5f6368;
  font-size: 15px;
}
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: #323232;
  color: #fff;
  padding: 14px 24px;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 500;
  z-index: 1000;
  transition: transform 0.3s ease;
  pointer-events: none;
}
.toast.show {
  transform: translateX(-50%) translateY(0);
}

/* Tablet Landscape */
@media (max-width: 1100px) {
  .panel-left { flex: 0 0 340px; }
}

/* Tablet Portrait / Mobile */
@media (max-width: 800px) {
  .app {
    flex-direction: column;
    gap: 0;
    padding: 0;
  }
  .panel {
    border-radius: 0;
  }
  .panel-left {
    flex: none;
    max-height: 55vh;
  }
  .panel-right {
    flex: 1;
    min-height: 45vh;
  }
}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<div class="app">
  <div class="panel panel-left">
    <div class="panel-header">Bildfahrplan</div>
    <div class="panel-content">

      <div class="section">
        <div class="section-title">Datei</div>
        <div class="btn-row">
          <button class="btn btn-secondary btn-full" onclick="manualSave()">üíæ Speichern</button>
          <button class="btn btn-secondary btn-full" onclick="manualLoad()">üìÇ Laden</button>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Bahnh√∂fe</div>
        <textarea id="stations" placeholder="Station A&#10;Station B&#10;Station C"></textarea>
      </div>

      <div class="section">
        <div class="section-title">Zeitraum</div>
        <div class="row">
          <div>
            <label>Start</label>
            <input type="time" id="timeStart" value="06:00">
          </div>
          <div>
            <label>Ende</label>
            <input type="time" id="timeEnd" value="22:00">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Raster</label>
            <select id="gridMinutes">
              <option value="5">5 Minuten</option>
              <option value="10">10 Minuten</option>
              <option value="15" selected>15 Minuten</option>
              <option value="30">30 Minuten</option>
            </select>
          </div>
          <div>
            <label>Beschriftung</label>
            <select id="showLabels">
              <option value="yes">Zugnummer an</option>
              <option value="no">Zugnummer aus</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Aktionen</div>
        <div class="btn-row">
          <button class="btn btn-primary btn-full" onclick="addTrain()">+ Zug</button>
          <button class="btn btn-warning btn-full" onclick="loadExample()">Beispiel</button>
        </div>
        <div class="btn-row">
          <button class="btn btn-success btn-full" onclick="exportPNG()">üì∑ PNG Export</button>
          <button class="btn btn-danger btn-full" onclick="clearAll()">üóëÔ∏è Leeren</button>
        </div>
      </div>

      <div class="section">
        <div class="legend">
          <div class="legend-item"><div class="legend-color" style="background:#c62828"></div>ICE/IC</div>
          <div class="legend-item"><div class="legend-color" style="background:#1565c0"></div>RE</div>
          <div class="legend-item"><div class="legend-color" style="background:#2e7d32"></div>RB</div>
          <div class="legend-item"><div class="legend-color" style="background:#f9a825"></div>S-Bahn</div>
          <div class="legend-item"><div class="legend-color" style="background:#7b1fa2"></div>Sonstige</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Z√ºge</div>
        <div id="trains"></div>
      </div>

    </div>
  </div>

  <div class="panel panel-right">
    <div class="panel-header">Diagramm</div>
    <div class="canvas-container">
      <canvas id="canvas"></canvas>
    </div>
    <div class="status-bar" id="status">Bereit</div>
  </div>
</div>

<script>
(function() {
  'use strict';

  var STORAGE_KEY = 'bildfahrplan_v2';
  var trains = [];
  var drawCounter = 0;
  var canvas, ctx, dpr = 1;

  var trainColors = {
    'ICE': '#c62828', 'IC': '#c62828', 'EC': '#c62828',
    'RE': '#1565c0', 'RB': '#2e7d32', 'S': '#f9a825',
    'default': '#7b1fa2'
  };

  function showToast(msg) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 2000);
  }

  function getColor(type) {
    if (!type) return trainColors['default'];
    var t = type.toUpperCase().trim();
    if (t.indexOf('ICE') === 0) return trainColors['ICE'];
    if (t.indexOf('IC') === 0 || t.indexOf('EC') === 0) return trainColors['IC'];
    if (t.indexOf('RE') === 0) return trainColors['RE'];
    if (t.indexOf('RB') === 0) return trainColors['RB'];
    if (t.indexOf('S') === 0 && t.length <= 4) return trainColors['S'];
    return trainColors['default'];
  }

  function parseTime(str) {
    if (!str || typeof str !== 'string') return null;
    var m = str.trim().match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return null;
    var h = parseInt(m[1], 10), min = parseInt(m[2], 10);
    if (h < 0 || h > 23 || min < 0 || min > 59) return null;
    return h * 60 + min;
  }

  function formatTime(minutes) {
    var h = Math.floor((minutes % 1440) / 60);
    var m = minutes % 60;
    return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
  }

  function getStations() {
    return document.getElementById('stations').value.split('\n').map(function(s) { return s.trim(); }).filter(Boolean);
  }

  function getTimeRange() {
    var start = parseTime(document.getElementById('timeStart').value) || 360;
    var end = parseTime(document.getElementById('timeEnd').value) || 1320;
    if (end <= start) end += 1440;
    return { start: start, end: end };
  }

  function getGridMinutes() {
    return parseInt(document.getElementById('gridMinutes').value, 10) || 15;
  }

  function showLabels() {
    return document.getElementById('showLabels').value === 'yes';
  }

  function setStatus(msg, warn) {
    var el = document.getElementById('status');
    el.innerHTML = '<span class="' + (warn ? 'status-warn' : 'status-ok') + '">' + msg + '</span>';
  }

  // ===== MANUELLES SPEICHERN / LADEN =====

  window.manualSave = function() {
    try {
      var data = {
        stations: document.getElementById('stations').value,
        timeStart: document.getElementById('timeStart').value,
        timeEnd: document.getElementById('timeEnd').value,
        gridMinutes: document.getElementById('gridMinutes').value,
        showLabels: document.getElementById('showLabels').value,
        trains: trains
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      showToast('Gespeichert!');
    } catch (e) {
      showToast('Fehler beim Speichern');
    }
  };

  window.manualLoad = function() {
    try {
      var json = localStorage.getItem(STORAGE_KEY);
      if (!json) {
        showToast('Keine gespeicherten Daten');
        return;
      }
      var data = JSON.parse(json);
      if (data.stations) document.getElementById('stations').value = data.stations;
      if (data.timeStart) document.getElementById('timeStart').value = data.timeStart;
      if (data.timeEnd) document.getElementById('timeEnd').value = data.timeEnd;
      if (data.gridMinutes) document.getElementById('gridMinutes').value = data.gridMinutes;
      if (data.showLabels) document.getElementById('showLabels').value = data.showLabels;
      if (data.trains) trains = data.trains;
      renderTrains();
      draw();
      showToast('Geladen!');
    } catch (e) {
      showToast('Fehler beim Laden');
    }
  };

  // ===== ZUG-VERWALTUNG =====

  window.addTrain = function() {
    trains.push({ id: 'z' + Date.now(), number: '', type: '', stops: {} });
    renderTrains();
    draw();
  };

  function removeTrain(id) {
    trains = trains.filter(function(t) { return t.id !== id; });
    renderTrains();
    draw();
  }

  function updateTrain(id, field, value) {
    for (var i = 0; i < trains.length; i++) {
      if (trains[i].id === id) { trains[i][field] = value; break; }
    }
  }

  function updateStop(trainId, station, field, value) {
    for (var i = 0; i < trains.length; i++) {
      if (trains[i].id === trainId) {
        if (!trains[i].stops[station]) trains[i].stops[station] = { arr: '', dep: '' };
        trains[i].stops[station][field] = value;
        break;
      }
    }
  }

  function renderTrains() {
    var container = document.getElementById('trains');
    container.innerHTML = '';
    var stations = getStations();

    if (trains.length === 0) {
      container.innerHTML = '<div class="empty-hint">Noch keine Z√ºge. Tippe auf "+ Zug".</div>';
      return;
    }

    trains.forEach(function(train) {
      var card = document.createElement('div');
      card.className = 'zug-card';

      var header = document.createElement('div');
      header.className = 'zug-card-header';

      var numInput = document.createElement('input');
      numInput.type = 'text';
      numInput.placeholder = 'Zugnummer';
      numInput.value = train.number;
      numInput.style.flex = '1';
      numInput.oninput = function() { updateTrain(train.id, 'number', this.value); };

      var typeInput = document.createElement('input');
      typeInput.type = 'text';
      typeInput.placeholder = 'Art';
      typeInput.value = train.type;
      typeInput.style.flex = '0.5';
      typeInput.oninput = function() { updateTrain(train.id, 'type', this.value); };

      var delBtn = document.createElement('button');
      delBtn.className = 'btn btn-danger btn-icon';
      delBtn.innerHTML = '‚úï';
      delBtn.onclick = function() { removeTrain(train.id); };

      header.appendChild(numInput);
      header.appendChild(typeInput);
      header.appendChild(delBtn);
      card.appendChild(header);

      if (stations.length > 0) {
        var grid = document.createElement('div');
        grid.className = 'stops-grid';

        grid.innerHTML = '<div class="stops-grid-header">Station</div><div class="stops-grid-header">Ank</div><div class="stops-grid-header">Abf</div>';

        stations.forEach(function(st) {
          var stop = train.stops[st] || { arr: '', dep: '' };

          var nameDiv = document.createElement('div');
          nameDiv.className = 'stop-name';
          nameDiv.textContent = st;
          nameDiv.title = st;

          var arrInput = document.createElement('input');
          arrInput.type = 'time';
          arrInput.value = stop.arr;
          arrInput.onchange = function() { updateStop(train.id, st, 'arr', this.value); draw(); };

          var depInput = document.createElement('input');
          depInput.type = 'time';
          depInput.value = stop.dep;
          depInput.onchange = function() { updateStop(train.id, st, 'dep', this.value); draw(); };

          grid.appendChild(nameDiv);
          grid.appendChild(arrInput);
          grid.appendChild(depInput);
        });

        card.appendChild(grid);
      } else {
        var hint = document.createElement('div');
        hint.className = 'empty-hint';
        hint.textContent = 'Zuerst Bahnh√∂fe eingeben';
        card.appendChild(hint);
      }

      container.appendChild(card);
    });
  }

  window.loadExample = function() {
    document.getElementById('stations').value = 'Hamburg Hbf\nHannover Hbf\nG√∂ttingen\nKassel-Wh.\nFulda\nFrankfurt Hbf';
    document.getElementById('timeStart').value = '08:00';
    document.getElementById('timeEnd').value = '12:00';
    document.getElementById('gridMinutes').value = '15';

    trains = [
      { id: 'ex1', number: 'ICE 571', type: 'ICE', stops: {
        'Hamburg Hbf': { arr: '', dep: '08:15' }, 'Hannover Hbf': { arr: '09:05', dep: '09:10' },
        'G√∂ttingen': { arr: '09:35', dep: '09:37' }, 'Kassel-Wh.': { arr: '09:55', dep: '09:57' },
        'Fulda': { arr: '10:25', dep: '10:27' }, 'Frankfurt Hbf': { arr: '11:00', dep: '' }
      }},
      { id: 'ex2', number: 'ICE 574', type: 'ICE', stops: {
        'Frankfurt Hbf': { arr: '', dep: '09:00' }, 'Fulda': { arr: '09:33', dep: '09:35' },
        'Kassel-Wh.': { arr: '10:03', dep: '10:05' }, 'G√∂ttingen': { arr: '10:23', dep: '10:25' },
        'Hannover Hbf': { arr: '10:50', dep: '10:55' }, 'Hamburg Hbf': { arr: '11:45', dep: '' }
      }},
      { id: 'ex3', number: 'RE 5', type: 'RE', stops: {
        'Hamburg Hbf': { arr: '', dep: '08:30' }, 'Hannover Hbf': { arr: '10:00', dep: '10:10' },
        'G√∂ttingen': { arr: '10:55', dep: '11:00' }, 'Kassel-Wh.': { arr: '11:30', dep: '' }
      }}
    ];
    renderTrains();
    draw();
    showToast('Beispiel geladen');
  };

  window.clearAll = function() {
    if (trains.length > 0 || document.getElementById('stations').value) {
      if (!confirm('Alle Daten l√∂schen?')) return;
    }
    trains = [];
    document.getElementById('stations').value = '';
    document.getElementById('timeStart').value = '06:00';
    document.getElementById('timeEnd').value = '22:00';
    renderTrains();
    draw();
    showToast('Geleert');
  };

  // ===== CANVAS =====

  function resizeCanvas() {
    var container = canvas.parentElement;
    var rect = container.getBoundingClientRect();
    var w = rect.width || 600, h = rect.height || 400;
    if (w < 100) w = 600;
    if (h < 100) h = 400;

    dpr = Math.min(window.devicePixelRatio || 1, 2);
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  window.draw = function() {
    try {
      resizeCanvas();
      drawCounter++;

      var stations = getStations();
      var range = getTimeRange();
      var gridMin = getGridMinutes();
      var labels = showLabels();

      var W = canvas.width / dpr, H = canvas.height / dpr;
      var mL = 48, mR = 16, mT = 42, mB = 20;
      var pW = W - mL - mR, pH = H - mT - mB;

      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, W, H);

      if (stations.length === 0) {
        ctx.fillStyle = '#5f6368';
        ctx.font = '16px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Bahnh√∂fe eingeben', W / 2, H / 2);
        setStatus('Gezeichnet #' + drawCounter + ' ‚Äì Keine Bahnh√∂fe');
        return;
      }

      var totalMin = range.end - range.start || 60;

      function timeToY(t) {
        var n = t - range.start;
        if (n < 0) n += 1440;
        return mT + (n / totalMin) * pH;
      }

      function stationToX(i) {
        return stations.length === 1 ? mL + pW / 2 : mL + (i / (stations.length - 1)) * pW;
      }

      // Plot background
      ctx.fillStyle = '#f8f9fa';
      ctx.fillRect(mL, mT, pW, pH);

      // Time grid
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';

      for (var t = range.start; t <= range.end; t += gridMin) {
        var y = Math.round(timeToY(t)) + 0.5;
        var isHour = t % 60 === 0, isHalf = t % 60 === 30;

        ctx.beginPath();
        ctx.moveTo(mL, y);
        ctx.lineTo(mL + pW, y);
        ctx.strokeStyle = isHour ? '#5f6368' : isHalf ? '#9aa0a6' : '#dadce0';
        ctx.lineWidth = isHour ? 1.5 : 1;
        ctx.stroke();

        var shouldLabel = gridMin >= 15 || (t - range.start) % 30 === 0 || isHour;
        if (shouldLabel) {
          ctx.fillStyle = isHour ? '#202124' : '#5f6368';
          ctx.font = isHour ? 'bold 11px sans-serif' : '10px sans-serif';
          ctx.fillText(formatTime(t), mL - 4, timeToY(t));
        }
      }

      // Station grid
      for (var i = 0; i < stations.length; i++) {
        var x = Math.round(stationToX(i)) + 0.5;
        ctx.beginPath();
        ctx.moveTo(x, mT);
        ctx.lineTo(x, mT + pH);
        ctx.strokeStyle = '#9aa0a6';
        ctx.lineWidth = 1;
        ctx.stroke();
      }

      // Station names
      ctx.font = '11px sans-serif';
      ctx.fillStyle = '#202124';
      for (var i = 0; i < stations.length; i++) {
        ctx.save();
        ctx.translate(stationToX(i), mT - 4);
        ctx.rotate(-Math.PI / 4);
        ctx.textAlign = 'left';
        ctx.textBaseline = 'bottom';
        ctx.fillText(stations[i], 0, 0);
        ctx.restore();
      }

      // Frame
      ctx.strokeStyle = '#202124';
      ctx.lineWidth = 2;
      ctx.strokeRect(Math.round(mL), Math.round(mT), Math.round(pW), Math.round(pH));

      // Trains
      var warnings = [];
      trains.forEach(function(train) {
        var color = getColor(train.type);
        var points = [];

        stations.forEach(function(st, si) {
          var stop = train.stops[st];
          if (!stop) return;
          var arr = parseTime(stop.arr), dep = parseTime(stop.dep);
          if (arr === null && dep === null) return;
          var x = stationToX(si);

          if (arr !== null && dep !== null) {
            points.push({ x: x, t: arr, type: 'arr', si: si });
            points.push({ x: x, t: dep, type: 'dep', si: si });
          } else {
            points.push({ x: x, t: arr !== null ? arr : dep, type: 'single', si: si });
          }
        });

        if (points.length === 0) return;

        // Midnight correction
        var lastT = null;
        points.forEach(function(p) {
          if (lastT !== null) {
            while (p.t < lastT - 120) p.t += 1440;
            if (p.t < lastT && p.type !== 'dep') {
              warnings.push(train.number + ': Zeit-Fehler');
            }
          }
          lastT = p.t;
        });

        // Draw line
        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        points.forEach(function(p, i) {
          var y = timeToY(p.t);
          if (i === 0) ctx.moveTo(p.x, y); else ctx.lineTo(p.x, y);
        });
        ctx.stroke();

        // Draw points
        ctx.fillStyle = color;
        points.forEach(function(p) {
          ctx.beginPath();
          ctx.arc(p.x, timeToY(p.t), 4, 0, Math.PI * 2);
          ctx.fill();
        });

        // Label
        if (labels && train.number && points.length >= 2) {
          var mi = Math.max(0, Math.floor(points.length / 2) - 1);
          var p1 = points[mi], p2 = points[Math.min(mi + 1, points.length - 1)];
          var mx = (p1.x + p2.x) / 2, my = (timeToY(p1.t) + timeToY(p2.t)) / 2;
          var angle = Math.atan2(timeToY(p2.t) - timeToY(p1.t), p2.x - p1.x);

          ctx.save();
          ctx.translate(mx, my);
          ctx.rotate(angle);
          ctx.font = 'bold 10px sans-serif';
          var tw = ctx.measureText(train.number).width;
          ctx.fillStyle = 'rgba(255,255,255,0.92)';
          ctx.fillRect(-3, -13, tw + 6, 15);
          ctx.fillStyle = color;
          ctx.textAlign = 'left';
          ctx.textBaseline = 'bottom';
          ctx.fillText(train.number, 0, 0);
          ctx.restore();
        }
      });

      var status = 'Gezeichnet #' + drawCounter;
      if (trains.length) status += ' ‚Äì ' + trains.length + ' Z√ºge';
      if (warnings.length) status += ' ‚Äì ' + warnings.length + ' Warnungen';
      setStatus(status, warnings.length > 0);

    } catch (e) {
      setStatus('Fehler: ' + e.message, true);
    }
  };

  window.exportPNG = function() {
    draw();
    requestAnimationFrame(function() {
      requestAnimationFrame(function() {
        try {
          var url = canvas.toDataURL('image/png');
          var link = document.createElement('a');
          link.download = 'bildfahrplan.png';
          link.href = url;
          link.click();
          showToast('PNG exportiert');
        } catch (e) {
          showToast('Export fehlgeschlagen');
        }
      });
    });
  };

  // ===== INIT =====

  function init() {
    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d');

    ['stations', 'timeStart', 'timeEnd', 'gridMinutes', 'showLabels'].forEach(function(id) {
      var el = document.getElementById(id);
      el.addEventListener('change', function() { renderTrains(); draw(); });
      if (el.tagName === 'TEXTAREA') {
        el.addEventListener('input', function() { renderTrains(); draw(); });
      }
    });

    window.addEventListener('resize', draw);
    renderTrains();
    draw();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>
